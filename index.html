<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Vault v8.0 - Cloud Catalog</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f1115',
                            card: '#111827',
                            border: '#374151',
                            text: '#ffffff',
                            subtext: '#9ca3af',
                            accent: '#6366f1'
                        },
                        light: {
                            bg: '#f3f4f6',
                            card: '#ffffff',
                            border: '#e5e7eb',
                            text: '#111827',
                            subtext: '#4b5563',
                            accent: '#4f46e5'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.5); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.8); }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text transition-colors duration-300 overflow-y-scroll">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback, useRef } = React;
        
        // --- CONFIG ---
        const supabaseClient = window.supabase.createClient(
              "https://ugllcdapuzihpkgcoaxj.supabase.co",
              "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbGxjZGFwdXppaHBrZ2NvYXhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTA3NzksImV4cCI6MjA4NjA2Njc3OX0.73I1cW1fqRUha5_6spK7C8m-SXUHQQfyjmcbNNbdfCI"
        );

        // --- ICONS ---
        const IconBase = ({ size = 20, className, children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const Film = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></IconBase>;
        const Tv = (p) => <IconBase {...p}><rect width="20" height="15" x="2" y="7" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></IconBase>;
        const Star = ({ fill, ...p }) => <IconBase {...p} fill={fill || "none"}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Settings = (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const LogIn = (p) => <IconBase {...p}><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Database = (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></IconBase>;
        const Copy = (p) => <IconBase {...p}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></IconBase>;
        const Plus = (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></IconBase>;
        const Server = (p) => <IconBase {...p}><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></IconBase>;

        // Custom Vault Logo
        const VaultLogoIcon = (p) => (
            <IconBase {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                <path d="M3 7h2v10H3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1z" fill="currentColor" fillOpacity="0.2" />
                <path d="M5 9h2" strokeLinecap="round" />
                <path d="M5 15h2" strokeLinecap="round" />
                <circle cx="15" cy="12" r="8" strokeWidth="2" />
                <circle cx="15" cy="12" r="6.2" strokeDasharray="0.5 2.5" strokeLinecap="round" strokeWidth="1.5" className="opacity-60" />
                <circle cx="15" cy="12" r="3" strokeWidth="1.5" />
                <path d="M15 9V6" strokeLinecap="round" />
                <path d="M15 15v3" strokeLinecap="round" />
            </IconBase>
        );

        // --- CONSTANTS ---
        const DEFAULT_KEYS = { omdb: '5591108c', tmdb: '68b27c1f85725736f0aec18b903197b0', rapid: '9782bOaf7fmsh8b54c22e5cOaf5cp13e6e8jsn8e2e765657a5' };
        const RAPID_HOST_MDL = "mydramalist-api.p.rapidapi.com"; 

        // --- SQL FOR USER ---
        const DB_SCHEMA_SQL = `
-- 1. CATALOG ITEMS (Shared Inventory)
create table if not exists catalog_items (
  id uuid default gen_random_uuid() primary key,
  imdb_id text not null,
  title text not null,
  type text check (type in ('movie', 'series', 'anime')),
  available boolean default true,
  source text default 'gdrive',
  quality text[] default '{}', -- e.g. ['1080p', '4K']
  languages text[] default '{}',
  subtitles text[] default '{}',
  meta jsonb default '{}', -- rich metadata (poster, ratings, cast)
  added_at timestamp default now()
);
alter table catalog_items enable row level security;
create policy "Public read catalog" on catalog_items for select using (true);
create policy "Owners write catalog" on catalog_items for insert with check (
  exists (select 1 from user_roles where user_id = auth.uid() and role = 'owner')
);

-- 2. USER ROLES (RBAC)
create table if not exists user_roles (
  user_id uuid references auth.users primary key,
  role text default 'viewer' check (role in ('owner', 'viewer'))
);
alter table user_roles enable row level security;
create policy "Users read own role" on user_roles for select using (auth.uid() = user_id);
-- Insert your own user ID manually as 'owner' to bootstrap

-- 3. USER ACTIVITY (Personal Watch Status)
create table if not exists user_activity (
  user_id uuid references auth.users,
  catalog_id uuid references catalog_items(id),
  watched boolean default false,
  rating int check (rating between 1 and 10),
  primary key (user_id, catalog_id)
);
alter table user_activity enable row level security;
create policy "Users manage own activity" on user_activity for all using (auth.uid() = user_id);

-- 4. MDL Registry (Legacy but useful)
create table if not exists mdl_registry (
  mdl_id text primary key,
  title text,
  rating float,
  votes int,
  poster_url text,
  raw jsonb
);
alter table mdl_registry enable row level security;
create policy "Public read registry" on mdl_registry for select using (true);
`;

        // --- GLOBAL CACHE SYSTEM (30-DAY TTL) ---
        const CACHE_TTL_30_DAYS = 30 * 24 * 60 * 60 * 1000;
        
        const cacheGet = (key) => {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return null;
                const { data, ts } = JSON.parse(raw);
                if (Date.now() - ts > CACHE_TTL_30_DAYS) {
                    localStorage.removeItem(key);
                    return null;
                }
                return data;
            } catch (e) { return null; }
        };

        const cacheSet = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify({ data, ts: Date.now() }));
            } catch (e) { console.warn("Cache quota exceeded"); }
        };

        const normalize = (q) => q.toLowerCase().trim().replace(/[^a-z0-9]/g, '');

        // --- API HELPERS (Used for creating Catalog Items) ---
        const fetchOmdbCached = async (url) => {
            const key = `omdb:${url}`;
            const cached = cacheGet(key);
            if (cached) return cached;
            try {
                const res = await fetch(url);
                const json = await res.json();
                cacheSet(key, json);
                return json;
            } catch(e) { console.error("OMDb Error", e); return null; }
        };

        const fetchTmdbCached = async (endpoint, apiKey) => {
            if (!apiKey) return null;
            const key = `tmdb:${endpoint}`;
            const cached = cacheGet(key);
            if (cached) return cached;
            try {
                const sep = endpoint.includes('?') ? '&' : '?';
                const res = await fetch(`https://api.themoviedb.org/3/${endpoint}${sep}api_key=${apiKey}`);
                if (!res.ok) return null;
                const json = await res.json();
                cacheSet(key, json);
                return json;
            } catch(e) { console.error("TMDB Error", e); return null; }
        };

        // --- AUTH COMPONENT ---
        const AuthModal = ({ isOpen, onClose, onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            if (!isOpen) return null;

            const handleSubmit = async (e) => {
              e.preventDefault();
              setError("");
              try {
                if (isRegister) {
                  const { error } = await supabaseClient.auth.signUp({ email, password });
                  if (error) throw error;
                  alert("Registered! Now login.");
                  setIsRegister(false);
                } else {
                  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                  if (error) throw error;
                  onLogin(data.session);
                  onClose();
                }
              } catch (err) { setError(err.message); }
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-fade-in">
                    <div className="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl shadow-2xl border border-light-border dark:border-dark-border p-8 relative">
                         <div className="text-center mb-8">
                             <div className="inline-block p-3 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 mb-4"><VaultLogoIcon size={48} /></div>
                             <h2 className="text-2xl font-black text-gray-900 dark:text-white uppercase tracking-wider">{isRegister ? 'Join The Vault' : 'Welcome Back'}</h2>
                         </div>
                         {error && <div className="mb-4 p-3 bg-red-100 text-red-700 text-sm rounded-lg">{error}</div>}
                         <form onSubmit={handleSubmit} className="space-y-4">
                             <div><label className="block text-xs font-bold uppercase text-gray-500 mb-1">Email</label><input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 text-sm outline-none focus:border-indigo-500 dark:text-white" required /></div>
                             <div><label className="block text-xs font-bold uppercase text-gray-500 mb-1">Password</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 text-sm outline-none focus:border-indigo-500 dark:text-white" required /></div>
                             <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-indigo-600/20">{isRegister ? 'Create Account' : 'Enter Catalog'}</button>
                         </form>
                         <div className="mt-6 text-center"><button onClick={() => setIsRegister(!isRegister)} className="text-sm text-gray-500 hover:text-indigo-600 dark:hover:text-white transition-colors">{isRegister ? 'Already have an account? Login' : 'Need an account? Register'}</button></div>
                    </div>
                </div>
            );
        }

        // --- SETTINGS MODAL ---
        const SettingsModal = ({ isOpen, onClose, apiKeys, setApiKeys, theme, setTheme }) => {
            const [activeTab, setActiveTab] = useState('general');
            const [copySuccess, setCopySuccess] = useState('');

            if (!isOpen) return null;

            const copySQL = () => {
                navigator.clipboard.writeText(DB_SCHEMA_SQL);
                setCopySuccess('Copied!');
                setTimeout(() => setCopySuccess(''), 2000);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-dark-card w-full max-w-lg rounded-2xl shadow-2xl border border-light-border dark:border-dark-border p-6 relative flex flex-col max-h-[90vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-white"><X size={20} /></button>
                        <h2 className="text-xl font-bold mb-6 dark:text-white flex items-center gap-2"><Settings size={20} /> App Settings</h2>
                        
                        <div className="flex gap-4 border-b border-gray-200 dark:border-gray-700 mb-6">
                            <button onClick={() => setActiveTab('general')} className={`pb-2 text-sm font-medium transition-colors ${activeTab === 'general' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}>General</button>
                            <button onClick={() => setActiveTab('database')} className={`pb-2 text-sm font-medium transition-colors ${activeTab === 'database' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}>Database</button>
                        </div>

                        <div className="overflow-y-auto custom-scrollbar flex-1">
                            {activeTab === 'general' && (
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 block">Appearance</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => setTheme('light')} className={`py-2 rounded-lg text-sm font-medium border ${theme === 'light' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-gray-200 dark:border-gray-700 dark:text-gray-400'}`}>Light Mode</button>
                                            <button onClick={() => setTheme('dark')} className={`py-2 rounded-lg text-sm font-medium border ${theme === 'dark' ? 'bg-indigo-900/30 border-indigo-500 text-indigo-300' : 'border-gray-200 dark:border-gray-700 dark:text-gray-400'}`}>Dark Mode</button>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 block">API Connections</label>
                                        <div className="space-y-3">
                                            <input type="text" placeholder="OMDb API Key" value={apiKeys.omdb} onChange={(e) => setApiKeys(p => ({...p, omdb: e.target.value}))} className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500 dark:text-white" />
                                            <input type="text" placeholder="TMDB API Key" value={apiKeys.tmdb} onChange={(e) => setApiKeys(p => ({...p, tmdb: e.target.value}))} className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500 dark:text-white" />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'database' && (
                                <div className="space-y-4">
                                    <div className="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                        <h3 className="text-sm font-bold text-yellow-800 dark:text-yellow-200 flex items-center gap-2"><Database size={16}/> Setup Required</h3>
                                        <p className="text-xs text-yellow-700 dark:text-yellow-300 mt-1">Run this SQL in Supabase to enable the Catalog, RBAC, and Activity tracking.</p>
                                    </div>
                                    <div className="relative">
                                        <pre className="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg text-[10px] font-mono text-gray-600 dark:text-gray-300 overflow-x-auto whitespace-pre-wrap border border-gray-200 dark:border-gray-700">
                                            {DB_SCHEMA_SQL}
                                        </pre>
                                        <button onClick={copySQL} className="absolute top-2 right-2 p-2 bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                                            {copySuccess ? <span className="text-xs font-bold text-green-500">{copySuccess}</span> : <Copy size={14} className="text-gray-500"/>}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP (NEW STATE MODEL) ---
        function App() {
            // ðŸ” Auth
            const [session, setSession] = useState(null);
            const [role, setRole] = useState("viewer"); // 'owner' | 'viewer'

            // ðŸ“š Shared catalog (cloud inventory)
            const [catalog, setCatalog] = useState([]);
            
            // ðŸ‘¤ Optional personal activity
            const [activity, setActivity] = useState({}); // keyed by catalog_id

            // ðŸ” Discovery UI
            const [searchQuery, setSearchQuery] = useState("");
            const [filters, setFilters] = useState({
                type: "all",
                quality: [],
                language: [],
                available: true
            });
            const [searchResults, setSearchResults] = useState([]); // For Adding items only

            // ðŸŽ¬ Selection
            const [selectedItem, setSelectedItem] = useState(null);
            const [addItemModal, setAddItemModal] = useState(null); // For owners to configure adding

            // âš™ï¸ UI
            const [showSettings, setShowSettings] = useState(false);
            const [showAuth, setShowAuth] = useState(false);
            const [loading, setLoading] = useState(false);
            const [apiKeys, setApiKeys] = useState(DEFAULT_KEYS);
            const [theme, setTheme] = useState('dark');
            
            const searchTimeout = useRef(null);

            // --- 5ï¸âƒ£ LOAD DATA ---
            useEffect(() => {
                // A. Load Catalog (Everyone)
                supabaseClient
                    .from("catalog_items")
                    .select("*")
                    .order('added_at', { ascending: false })
                    .then(({ data, error }) => {
                        if (error) console.error("Catalog fetch error", error);
                        else setCatalog(data || []);
                    });
            }, []);

            useEffect(() => {
                if (!session) {
                    setRole("viewer");
                    setActivity({});
                    return;
                }

                // B. Load User Role
                supabaseClient
                    .from("user_roles")
                    .select("role")
                    .eq("user_id", session.user.id)
                    .single()
                    .then(({ data }) => setRole(data?.role || "viewer"));

                // C. Load Personal Activity
                supabaseClient
                    .from("user_activity")
                    .select("*")
                    .eq("user_id", session.user.id)
                    .then(({ data }) => {
                        const map = {};
                        data?.forEach(d => map[d.catalog_id] = d);
                        setActivity(map);
                    });
            }, [session]);

            // --- 6ï¸âƒ£ FILTERING & SEARCH ---
            const visibleCatalog = useMemo(() => {
                return catalog
                    .filter(i => i.available)
                    .filter(i => !searchQuery || i.title.toLowerCase().includes(searchQuery.toLowerCase()))
                    .filter(i => filters.type === "all" ? true : i.type === filters.type)
                    .filter(i => filters.quality.length === 0 || filters.quality.some(q => i.quality.includes(q)))
                    .filter(i => filters.language.length === 0 || filters.language.some(l => i.languages.includes(l)));
            }, [catalog, searchQuery, filters]);

            // --- 7ï¸âƒ£ OWNER ACTIONS ---
            const searchForAdd = async (q) => {
                if (!apiKeys.omdb || q.length < 3) return;
                const json = await fetchOmdbCached(`https://www.omdbapi.com/?apikey=${apiKeys.omdb}&s=${encodeURIComponent(q)}`);
                if (json.Search) setSearchResults(json.Search);
            };

            const handleSearchInput = (val) => {
                setSearchQuery(val);
                if (role === 'owner') {
                    if (searchTimeout.current) clearTimeout(searchTimeout.current);
                    searchTimeout.current = setTimeout(() => searchForAdd(val), 500);
                }
            };

            const openAddModal = async (imdbID) => {
                if (role !== 'owner') return;
                setLoading(true);
                // Fetch deep metadata to populate the catalog item
                const omdb = await fetchOmdbCached(`https://www.omdbapi.com/?apikey=${apiKeys.omdb}&i=${imdbID}&plot=full`);
                let tmdbData = null;
                
                // Try TMDB for higher quality
                if (apiKeys.tmdb) {
                     const find = await fetchTmdbCached(`find/${imdbID}?external_source=imdb_id`, apiKeys.tmdb);
                     const tmdbId = find?.movie_results?.[0]?.id || find?.tv_results?.[0]?.id;
                     if (tmdbId) {
                         tmdbData = await fetchTmdbCached(`${omdb.Type === 'series' ? 'tv' : 'movie'}/${tmdbId}`, apiKeys.tmdb);
                     }
                }

                const draftItem = {
                    imdb_id: imdbID,
                    title: omdb.Title,
                    type: omdb.Type === 'series' ? 'series' : 'movie',
                    available: true,
                    source: 'gdrive',
                    quality: ['1080p'],
                    languages: ['English'],
                    meta: {
                        poster: tmdbData ? `https://image.tmdb.org/t/p/w500${tmdbData.poster_path}` : omdb.Poster,
                        year: parseInt(omdb.Year),
                        runtime: omdb.Runtime,
                        genres: omdb.Genre.split(', '),
                        director: omdb.Director,
                        plot: omdb.Plot,
                        ratings: {
                            imdb: omdb.imdbRating
                        }
                    }
                };
                setAddItemModal(draftItem);
                setSearchResults([]); // Clear search results
                setLoading(false);
            };

            const saveCatalogItem = async () => {
                if (role !== 'owner' || !addItemModal) return;
                
                const { data, error } = await supabaseClient
                    .from("catalog_items")
                    .insert(addItemModal)
                    .select()
                    .single();

                if (error) {
                    alert("Error adding item: " + error.message);
                } else {
                    setCatalog(prev => [data, ...prev]);
                    setAddItemModal(null);
                    setSearchQuery("");
                }
            };

            // --- EFFECTS & HELPERS ---
            useEffect(() => {
                if (theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [theme]);
            
            useEffect(() => {
                const localKeys = localStorage.getItem('vault_v5_keys');
                if (localKeys) setApiKeys(JSON.parse(localKeys));
                
                // Auth Listener
                supabaseClient.auth.getSession().then(({ data }) => setSession(data.session));
                const { data: listener } = supabaseClient.auth.onAuthStateChange((_event, session) => setSession(session));
                return () => listener.subscription.unsubscribe();
            }, []);

            useEffect(() => { localStorage.setItem('vault_v5_keys', JSON.stringify(apiKeys)); }, [apiKeys]);

            return (
                <div className="min-h-screen pb-32 selection:bg-indigo-500 selection:text-white flex flex-col">
                    <AuthModal isOpen={showAuth} onClose={() => setShowAuth(false)} onLogin={setSession} />

                    {/* HEADER */}
                    <header className="sticky top-0 z-30 bg-white/80 dark:bg-dark-bg/80 backdrop-blur-md border-b border-light-border dark:border-dark-border px-4 h-16 flex items-center justify-between">
                         <div className="flex items-center gap-3">
                             <div className="text-indigo-600 dark:text-indigo-500"><VaultLogoIcon size={38} strokeWidth={1.5} /></div>
                             <div className="flex flex-col justify-center">
                                 <span className="text-[10px] font-bold tracking-[0.25em] leading-tight text-gray-500 dark:text-gray-400 uppercase pl-0.5">The</span>
                                 <span className="text-2xl font-black tracking-[0.15em] leading-none uppercase text-gray-900 dark:text-white font-sans">Vault</span>
                             </div>
                             {role === 'owner' && <span className="ml-2 bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wider">Owner Mode</span>}
                         </div>

                         <div className="flex items-center gap-3">
                             {!session ? (
                                 <button onClick={() => setShowAuth(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold transition-colors"><LogIn size={16} /> Login</button>
                             ) : (
                                 <div className="flex items-center gap-3">
                                     <div className="hidden md:flex flex-col items-end">
                                         <span className="text-xs font-bold dark:text-white">{session.user.email.split('@')[0]}</span>
                                         <span className="text-[10px] text-gray-500 capitalize">{role}</span>
                                     </div>
                                     <button onClick={() => supabaseClient.auth.signOut()} className="p-2 text-gray-500 hover:text-red-500"><User size={20}/></button>
                                 </div>
                             )}
                             <button onClick={() => setShowSettings(true)} className="p-2 text-gray-500 hover:text-indigo-600 dark:text-gray-400 dark:hover:text-white"><Settings size={20} /></button>
                         </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 max-w-7xl mx-auto px-4 pt-8 w-full">
                        
                        {/* DISCOVERY BAR */}
                        <div className="flex flex-col md:flex-row gap-4 mb-8 items-start md:items-center justify-between">
                            {/* SEARCH */}
                            <div className="relative w-full md:w-96 group">
                                <Search className="absolute left-3 top-2.5 text-gray-400 group-focus-within:text-indigo-500 transition-colors" size={16} />
                                <input 
                                    type="text" 
                                    placeholder={role === 'owner' ? "Search OMDb to add..." : "Search catalog..."}
                                    value={searchQuery} 
                                    onChange={(e) => handleSearchInput(e.target.value)}
                                    className="w-full bg-gray-100 dark:bg-gray-800 rounded-full pl-10 pr-4 py-2 text-sm text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all border border-transparent focus:border-indigo-500" 
                                />
                                {/* OWNER SEARCH RESULTS */}
                                {role === 'owner' && searchResults.length > 0 && (
                                    <div className="absolute z-50 mt-2 w-full bg-white dark:bg-dark-card rounded-xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-700">
                                        <div className="px-3 py-2 text-[10px] uppercase font-bold text-gray-400 bg-gray-50 dark:bg-gray-800/50">Add to Catalog</div>
                                        {searchResults.map((item) => (
                                            <div key={item.imdbID} onClick={() => openAddModal(item.imdbID)} className="flex items-center gap-3 px-4 py-3 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 cursor-pointer border-b border-gray-100 dark:border-gray-800 last:border-0 transition-colors">
                                                <div className="w-8 h-10 bg-gray-200 rounded overflow-hidden flex-shrink-0">
                                                    {item.Poster !== "N/A" && <img src={item.Poster} className="w-full h-full object-cover" />}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-bold text-sm dark:text-white truncate">{item.Title}</p>
                                                    <p className="text-xs text-gray-500">{item.Year} â€¢ {item.Type}</p>
                                                </div>
                                                <Plus size={16} className="text-indigo-500"/>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* FILTERS */}
                            <div className="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0 scrollbar-hide w-full md:w-auto">
                                <select 
                                    value={filters.type} 
                                    onChange={e => setFilters(p => ({...p, type: e.target.value}))}
                                    className="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-xs font-bold py-2 px-3 rounded-lg outline-none cursor-pointer"
                                >
                                    <option value="all">All Types</option>
                                    <option value="movie">Movies</option>
                                    <option value="series">TV Series</option>
                                </select>
                                <button 
                                    onClick={() => setFilters(p => ({...p, quality: p.quality.includes('4K') ? [] : ['4K']}))}
                                    className={`px-3 py-2 rounded-lg text-xs font-bold transition-colors whitespace-nowrap ${filters.quality.includes('4K') ? 'bg-indigo-600 text-white' : 'bg-gray-100 dark:bg-gray-800 text-gray-500'}`}
                                >
                                    4K Only
                                </button>
                            </div>
                        </div>

                        {/* CATALOG GRID */}
                        {visibleCatalog.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                                <Server size={48} className="mb-4 opacity-20"/>
                                <p className="text-sm font-medium">Catalog is empty or no matches found.</p>
                                {role === 'owner' && <p className="text-xs mt-2 opacity-60">Use the search bar to find and add items.</p>}
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-x-6 gap-y-10 pb-20">
                                {visibleCatalog.map((item) => {
                                    const userAct = activity[item.id];
                                    return (
                                    <div key={item.id} onClick={() => setSelectedItem(item)} className="group relative bg-white dark:bg-dark-card rounded-xl overflow-hidden shadow-sm hover:shadow-xl hover:scale-[1.02] transition-all cursor-pointer border border-light-border dark:border-dark-border">
                                        <div className="relative aspect-[2/3] overflow-hidden bg-gray-900">
                                            <img src={item.meta?.poster || "https://via.placeholder.com/300x450"} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" loading="lazy" />
                                            {/* Quality Badge */}
                                            {item.quality?.includes('4K') && <div className="absolute top-2 right-2 bg-black/60 backdrop-blur-md text-white px-1.5 py-0.5 rounded text-[10px] font-bold border border-white/10">4K</div>}
                                            {/* Watched Badge */}
                                            {userAct?.watched && <div className="absolute bottom-2 right-2 bg-green-500 text-white px-1.5 py-0.5 rounded-full shadow-lg"><CheckCircle size={12} fill="currentColor"/></div>}
                                        </div>
                                        <div className="p-3 space-y-1">
                                            <h3 className="font-bold text-sm line-clamp-1 dark:text-white">{item.title}</h3>
                                            <div className="flex items-center justify-between text-[11px] text-gray-500">
                                                <span>{item.meta?.year}</span>
                                                <span className="capitalize">{item.type}</span>
                                            </div>
                                            {item.languages?.length > 0 && (
                                                <div className="flex gap-1 pt-1">
                                                    {item.languages.slice(0,2).map(l => <span key={l} className="text-[9px] px-1 bg-gray-100 dark:bg-gray-800 rounded text-gray-500">{l.substring(0,2).toUpperCase()}</span>)}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )})}
                            </div>
                        )}
                    </main>

                    {/* ITEM DETAIL MODAL */}
                    {selectedItem && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-fade-in">
                            <div className="bg-white dark:bg-dark-card w-full max-w-2xl p-0 rounded-2xl relative max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
                                <div className="relative h-64 shrink-0">
                                    <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-10"></div>
                                    <img src={itemPoster(selectedItem)} className="w-full h-full object-cover" />
                                    <button onClick={() => setSelectedItem(null)} className="absolute top-4 right-4 bg-black/40 hover:bg-black/60 text-white p-2 rounded-full z-20 backdrop-blur-md transition-colors"><X size={20}/></button>
                                    
                                    <div className="absolute bottom-0 left-0 w-full p-6 z-20">
                                        <h2 className="text-3xl font-black text-white mb-2 leading-none drop-shadow-md">{selectedItem.title}</h2>
                                        <div className="flex items-center gap-3 text-white/80 text-sm font-medium">
                                            <span>{selectedItem.meta?.year}</span>
                                            <span className="w-1 h-1 bg-white/50 rounded-full"></span>
                                            <span className="capitalize">{selectedItem.type}</span>
                                            <span className="w-1 h-1 bg-white/50 rounded-full"></span>
                                            <span>{selectedItem.meta?.runtime}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-white dark:bg-dark-card">
                                    <div className="flex flex-col md:flex-row gap-6">
                                        <div className="flex-1 space-y-6">
                                            {/* Tech Specs */}
                                            <div className="flex flex-wrap gap-2">
                                                {selectedItem.quality?.map(q => <span key={q} className="px-2 py-1 rounded-md bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 text-xs font-bold border border-indigo-100 dark:border-indigo-800">{q}</span>)}
                                                {selectedItem.languages?.map(l => <span key={l} className="px-2 py-1 rounded-md bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 text-xs font-bold">{l}</span>)}
                                                <span className="px-2 py-1 rounded-md bg-green-50 dark:bg-green-900/20 text-green-600 text-xs font-bold border border-green-100 dark:border-green-800 flex items-center gap-1"><Server size={10}/> {selectedItem.source}</span>
                                            </div>

                                            <p className="text-gray-600 dark:text-gray-300 leading-relaxed text-sm">
                                                {selectedItem.meta?.plot || "No description available."}
                                            </p>

                                            {/* Ratings */}
                                            {selectedItem.meta?.ratings && (
                                                <div className="flex gap-4 border-t border-gray-100 dark:border-gray-800 pt-4">
                                                    {selectedItem.meta.ratings.imdb && <div className="text-xs font-bold text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20 px-2 py-1 rounded">IMDb {selectedItem.meta.ratings.imdb}</div>}
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Activity Sidebar */}
                                        <div className="w-full md:w-48 shrink-0 space-y-3">
                                            <button 
                                                className={`w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-lg ${activity[selectedItem.id]?.watched ? 'bg-green-500 text-white shadow-green-500/30' : 'bg-gray-100 dark:bg-gray-800 text-gray-500 hover:bg-indigo-600 hover:text-white'}`}
                                                onClick={() => {
                                                    // Optimistic update
                                                    const newVal = !activity[selectedItem.id]?.watched;
                                                    setActivity(p => ({...p, [selectedItem.id]: { ...p[selectedItem.id], watched: newVal }}));
                                                    supabaseClient.from('user_activity').upsert({ user_id: session.user.id, catalog_id: selectedItem.id, watched: newVal });
                                                }}
                                            >
                                                {activity[selectedItem.id]?.watched ? <><CheckCircle size={18}/> Watched</> : <><Eye size={18}/> Mark Watched</>}
                                            </button>
                                            
                                            {role === 'owner' && (
                                                <div className="pt-4 mt-4 border-t border-gray-100 dark:border-gray-800">
                                                    <p className="text-[10px] uppercase font-bold text-gray-400 mb-2">Owner Controls</p>
                                                    <button className="w-full py-2 rounded-lg border border-gray-200 dark:border-gray-700 text-xs font-bold text-gray-500 hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-colors flex items-center justify-center gap-2">
                                                        <Trash size={14}/> Remove Item
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ADD ITEM MODAL (OWNER) */}
                    {addItemModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
                            <div className="bg-white dark:bg-dark-card w-full max-w-lg p-6 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700">
                                <h2 className="text-xl font-black dark:text-white mb-6">Add to Catalog</h2>
                                
                                <div className="flex gap-4 mb-6">
                                    <div className="w-24 h-36 bg-gray-200 rounded-lg overflow-hidden shrink-0">
                                        <img src={addItemModal.meta.poster} className="w-full h-full object-cover"/>
                                    </div>
                                    <div>
                                        <h3 className="font-bold dark:text-white">{addItemModal.title}</h3>
                                        <p className="text-xs text-gray-500">{addItemModal.meta.year} â€¢ {addItemModal.type}</p>
                                        <div className="mt-2 text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded inline-block font-bold">New ID: {addItemModal.imdb_id}</div>
                                    </div>
                                </div>

                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Quality</label>
                                        <div className="flex gap-2">
                                            {['4K', '1080p', '720p', 'HDR'].map(q => (
                                                <button 
                                                    key={q}
                                                    onClick={() => setAddItemModal(p => ({...p, quality: p.quality.includes(q) ? p.quality.filter(x=>x!==q) : [...p.quality, q]}))}
                                                    className={`px-3 py-1.5 rounded-md text-xs font-bold border transition-colors ${addItemModal.quality.includes(q) ? 'bg-indigo-600 text-white border-indigo-600' : 'border-gray-200 dark:border-gray-700 text-gray-500'}`}
                                                >{q}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Languages</label>
                                        <div className="flex gap-2">
                                            {['English', 'Spanish', 'Japanese', 'Korean'].map(l => (
                                                <button 
                                                    key={l}
                                                    onClick={() => setAddItemModal(p => ({...p, languages: p.languages.includes(l) ? p.languages.filter(x=>x!==l) : [...p.languages, l]}))}
                                                    className={`px-3 py-1.5 rounded-md text-xs font-bold border transition-colors ${addItemModal.languages.includes(l) ? 'bg-indigo-600 text-white border-indigo-600' : 'border-gray-200 dark:border-gray-700 text-gray-500'}`}
                                                >{l}</button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => setAddItemModal(null)} className="flex-1 py-3 rounded-xl font-bold text-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Cancel</button>
                                    <button onClick={saveCatalogItem} className="flex-1 py-3 rounded-xl font-bold text-sm bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-colors">Confirm Add</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {loading && <div className="fixed inset-0 z-[70] bg-black/50 flex items-center justify-center"><div className="w-8 h-8 border-4 border-white/30 border-t-white rounded-full animate-spin"></div></div>}

                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} apiKeys={apiKeys} setApiKeys={setApiKeys} theme={theme} setTheme={setTheme} />
                </div>
            );
        }

        // Helper
        const itemPoster = (i) => i.meta?.poster || "https://via.placeholder.com/300x450";

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>