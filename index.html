<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Vault v9.0 - Clean Architecture</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f1115',
                            card: '#111827',
                            border: '#374151',
                            text: '#ffffff',
                            subtext: '#9ca3af',
                        },
                        light: {
                            bg: '#f8fafc',
                            card: '#ffffff',
                            border: '#e2e8f0',
                            text: '#0f172a',
                            subtext: '#64748b',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.6); }
        .drawer-backdrop { backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text transition-colors duration-200 h-screen overflow-hidden selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        // --- CORE FIX: Destructure Hooks from React Global ---
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        
        // --- CONFIG ---
        const supabaseClient = window.supabase.createClient(
              "https://ugllcdapuzihpkgcoaxj.supabase.co",
              "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbGxjZGFwdXppaHBrZ2NvYXhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTA3NzksImV4cCI6MjA4NjA2Njc3OX0.73I1cW1fqRUha5_6spK7C8m-SXUHQQfyjmcbNNbdfCI"
        );

        // --- ICONS (Lucide) ---
        const IconBase = ({ size = 18, className, children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const Film = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></IconBase>;
        const Tv = (p) => <IconBase {...p}><rect width="20" height="15" x="2" y="7" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></IconBase>;
        const Play = (p) => <IconBase {...p}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const Star = ({ fill, ...p }) => <IconBase {...p} fill={fill || "none"}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Repeat = (p) => <IconBase {...p}><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></IconBase>;
        const Globe = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>;
        const Grid = (p) => <IconBase {...p}><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></IconBase>;
        const List = (p) => <IconBase {...p}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>;
        const Filter = (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></IconBase>;
        const Layers = (p) => <IconBase {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></IconBase>;
        const Settings = (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Zap = (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const BarChart = (p) => <IconBase {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Calendar = (p) => <IconBase {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>;
        const Award = (p) => <IconBase {...p}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconBase>;
        const FastForward = (p) => <IconBase {...p}><polygon points="13 19 22 12 13 5 13 19" /><polygon points="2 19 11 12 2 5 2 19" /></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>;
        const Smile = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></IconBase>;
        const Share2 = (p) => <IconBase {...p}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></IconBase>;
        const RefreshCw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></IconBase>;
        const Edit = (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const CheckSquare = (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>;
        const LogIn = (p) => <IconBase {...p}><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (p) => <IconBase {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></IconBase>;
        const Database = (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></IconBase>;
        const Copy = (p) => <IconBase {...p}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></IconBase>;
        const Inbox = (p) => <IconBase {...p}><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></IconBase>;
        const MessageSquare = (p) => <IconBase {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></IconBase>;

        // Custom Vault Logo - Redesigned to match brand identity (Hinge + Radial + Bean)
        const VaultLogoIcon = (p) => (
            <IconBase {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                {/* Hinge Mechanism (Left) */}
                <path d="M3 8h3v8H3z" fill="currentColor" fillOpacity="0.15" stroke="none" />
                <path d="M3 8v8" strokeLinecap="round" />
                <path d="M6 8v8" strokeLinecap="round" />
                <path d="M6 10h1" strokeLinecap="round" />
                <path d="M6 14h1" strokeLinecap="round" />

                {/* Main Vault Body (Shifted Right) */}
                <circle cx="15.5" cy="12" r="7.5" strokeWidth="2" />
                <circle cx="15.5" cy="12" r="6" strokeWidth="1" strokeDasharray="0.5 2" strokeLinecap="round" className="opacity-50" />
                
                {/* Central Hub Ring */}
                <circle cx="15.5" cy="12" r="3" strokeWidth="1.5" className="text-indigo-500" stroke="currentColor" />
                
                {/* Radial Spokes */}
                <path d="M15.5 9V6" strokeLinecap="round" />
                <path d="M15.5 15v3" strokeLinecap="round" />
                <path d="M12.5 12H9.5" strokeLinecap="round" />
                <path d="M18.5 12h3" strokeLinecap="round" />
                <path d="M13.38 9.88L11.26 7.76" strokeLinecap="round" />
                <path d="M17.62 14.12L19.74 16.24" strokeLinecap="round" />
                <path d="M13.38 14.12L11.26 16.24" strokeLinecap="round" />
                <path d="M17.62 9.88L19.74 7.76" strokeLinecap="round" />

                {/* Brand Identity: Central Bean/Slit */}
                <ellipse cx="15.5" cy="12" rx="1.2" ry="1.8" fill="currentColor" className="text-indigo-600 dark:text-indigo-400" stroke="none" />
                <path d="M15.5 10.8c0.2 0 0.5 0.5 0.5 1.2c0 0.8 -0.3 1.2 -0.6 1.2" stroke="white" className="dark:stroke-gray-900" strokeWidth="1" strokeLinecap="round" />
            </IconBase>
        );

        // --- CONSTANTS ---
        const DEFAULT_KEYS = { omdb: '5591108c', tmdb: '68b27c1f85725736f0aec18b903197b0', rapid: '9782bOaf7fmsh8b54c22e5cOaf5cp13e6e8jsn8e2e765657a5' };
        const ADMIN_IDS = ["74e5b3ea-113f-4d6c-be2a-b0b52b2e92c3"];
        
        // --- CACHE & HELPERS ---
        const cacheGet = (key) => { try { const raw = localStorage.getItem(key); if (!raw) return null; const { data, ts } = JSON.parse(raw); if (Date.now() - ts > 30 * 24 * 60 * 60 * 1000) { localStorage.removeItem(key); return null; } return data; } catch (e) { return null; } };
        const cacheSet = (key, data) => { try { localStorage.setItem(key, JSON.stringify({ data, ts: Date.now() })); } catch (e) { console.warn("Cache quota"); } };
        const tmdbImg = (path, size = "w342") => path ? `https://image.tmdb.org/t/p/${size}${path}` : null;
        const getHighResPoster = (url, width = 600) => {
            if (!url || url === "N/A") return "https://via.placeholder.com/300x450?text=No+Poster";
            if (url.includes("media-amazon.com")) return url.replace(/_V1_.*\.jpg$/, `_V1_SX${width}.jpg`);
            if (url.includes("tmdb.org")) return url.replace(/\/w\d+\//, width > 700 ? "/original/" : `/w${width}/`);
            return url;
        };

        // --- HOOKS ---
        function useVaultStats(items) {
            return useMemo(() => {
                const stats = {
                    total: items.length,
                    watched: 0,
                    progress: 0,
                    avgRating: "â€“",
                    byGenre: {},
                    byYear: {},
                    byLanguage: {},
                    topRated: [],
                    rewatchCount: 0
                };

                let ratingSum = 0;
                let ratingCount = 0;

                items.forEach(item => {
                    const meta = item.userMeta || {};

                    if (meta.status === "watched") stats.watched++;
                    if (meta.status === "progress" || (item.Type === 'series' && meta.series?.lastEpisode?.season > 0 && meta.status !== 'watched')) stats.progress++;

                    if (meta.rewatchCount > 0) stats.rewatchCount += meta.rewatchCount;

                    if (meta.ratings?.overall > 0) {
                        ratingSum += meta.ratings.overall;
                        ratingCount++;
                    }

                    // Genre
                    (item.Genre || "").split(",").forEach(g => {
                        const key = g.trim();
                        if(key) stats.byGenre[key] = (stats.byGenre[key] || 0) + 1;
                    });

                    // Year
                    const year = item.Year;
                    if (year) stats.byYear[year] = (stats.byYear[year] || 0) + 1;

                    // Language
                    (item.Language || "").split(",").forEach(l => {
                        const key = l.trim();
                        if(key) stats.byLanguage[key] = (stats.byLanguage[key] || 0) + 1;
                    });
                });

                stats.avgRating = ratingCount
                    ? (ratingSum / ratingCount).toFixed(1)
                    : "â€“";

                stats.topRated = [...items]
                    .filter(i => i.userMeta?.ratings?.overall >= 9)
                    .sort((a,b) => b.userMeta.ratings.overall - a.userMeta.ratings.overall)
                    .slice(0, 5);

                return stats;
            }, [items]);
        }
        
        function useSeriesProgress(series) {
            return useMemo(() => {
                if (!series?.seasons?.length) {
                    return { watched: 0, total: 0, percent: 0 };
                }

                let watched = 0;
                let total = 0;

                series.seasons.forEach(season => {
                    season.episodes?.forEach(ep => {
                        total += 1;
                        if (ep.watched) watched += 1;
                    });
                });

                const percent = total ? Math.round((watched / total) * 100) : 0;

                return { watched, total, percent };
            }, [series]);
        }

        function useEpisodeStreak(items) {
            return useMemo(() => {
                const days = new Set();
                items.forEach(item => {
                    // Check watchedOn date
                    if (item.userMeta?.watchedOn) days.add(item.userMeta.watchedOn);
                    // Also check lastUpdated if watchedOn is not set but status is watched
                    if (item.userMeta?.status === 'watched' && item.userMeta.lastUpdated) {
                         days.add(new Date(item.userMeta.lastUpdated).toISOString().split('T')[0]);
                    }
                });

                const sorted = [...days].sort(); // YYYY-MM-DD
                if (!sorted.length) return { streak: 0, longest: 0 };

                let streak = 1;
                let longest = 1;
                
                // Very basic streak calc
                for (let i = 1; i < sorted.length; i++) {
                    const prev = new Date(sorted[i - 1]);
                    const curr = new Date(sorted[i]);
                    const diff = (curr - prev) / (1000 * 60 * 60 * 24);

                    if (Math.round(diff) === 1) {
                        streak++;
                        longest = Math.max(longest, streak);
                    } else if (Math.round(diff) > 1) {
                        streak = 1;
                    }
                }
                
                // Check if streak is current (today or yesterday)
                const lastDate = new Date(sorted[sorted.length - 1]);
                const today = new Date();
                const diffToToday = (today - lastDate) / (1000 * 60 * 60 * 24);
                if (diffToToday > 2) streak = 0; // Streak broken

                return { streak, longest };
            }, [items]);
        }

        function useAutoAdvance(series, onUpdate) {
            const [lastAction, setLastAction] = useState(null);

            const markNext = () => {
                if(!series?.seasons) return;
                // Sort seasons
                const seasons = [...series.seasons].sort((a,b) => a.season - b.season);
                for (const season of seasons) {
                    // Sort episodes
                    const eps = [...season.episodes].sort((a,b) => a.episode - b.episode);
                    for (const ep of eps) {
                        if (!ep.watched) {
                            onUpdate({ season: season.season, episode: ep.episode });
                            setLastAction({ season: season.season, episode: ep.episode });
                            return;
                        }
                    }
                }
            };

            const undo = () => {
                if (!lastAction) return;
                onUpdate({ ...lastAction, undo: true });
                setLastAction(null);
            };

            return { markNext, undo, lastAction };
        }

        // --- NEW COMPONENTS ---
        
        function EpisodeStreakCalendar({ items }) {
            const calendar = useMemo(() => {
                const map = {};
                items.forEach(item => {
                    const date = item.userMeta?.watchedOn;
                    if (!date) return;
                    map[date] = (map[date] || 0) + 1;
                });
                const today = new Date();
                const days = [];
                for (let i = 0; i < 120; i++) { // Last 4 months roughly
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    const key = d.toISOString().slice(0, 10);
                    days.push({ date: key, count: map[key] || 0 });
                }
                return days.reverse();
            }, [items]);

            return (
                <div className="bg-white dark:bg-dark-card p-6 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm mb-6">
                    <h3 className="text-[10px] font-bold uppercase tracking-widest text-gray-500 mb-4 flex items-center gap-2">
                        <Calendar size={14} /> Watching Activity
                    </h3>
                    <div className="flex flex-wrap gap-1">
                        {calendar.map(d => (
                            <div
                                key={d.date}
                                title={`${d.date}: ${d.count} watched`}
                                className={`w-2.5 h-2.5 rounded-sm transition-colors ${
                                    d.count === 0 ? "bg-gray-100 dark:bg-gray-800" :
                                    d.count < 2 ? "bg-indigo-300 dark:bg-indigo-900" :
                                    d.count < 4 ? "bg-indigo-500 dark:bg-indigo-600" :
                                    "bg-indigo-700 dark:bg-indigo-400"
                                }`}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        function GentleReminder({ items }) {
            const reminder = useMemo(() => {
                if (!items.length) return null;
                const lastWatched = items
                    .map(i => i.userMeta?.watchedOn)
                    .filter(Boolean)
                    .sort()
                    .pop();

                if (!lastWatched) return null;

                const diff = Math.floor((Date.now() - new Date(lastWatched)) / (1000 * 60 * 60 * 24));

                if (diff >= 3 && diff < 7) return `You havenâ€™t watched anything in ${diff} days.`;
                if (diff >= 7) return "Itâ€™s been a while. Ready to continue a series?";
                return null;
            }, [items]);

            if (!reminder) return null;

            return (
                <div className="mb-6 px-6">
                    <div className="bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-200 dark:border-yellow-900/30 p-3 rounded-xl text-sm font-medium text-yellow-800 dark:text-yellow-200 flex items-center gap-2 animate-fade-in">
                        <Clock size={16} /> {reminder}
                    </div>
                </div>
            );
        }

        function AnimatedProgressRing({ percent, size = 42, stroke = 4 }) {
            const radius = (size - stroke) / 2;
            const circumference = 2 * Math.PI * radius;
            const [animated, setAnimated] = useState(0);

            useEffect(() => {
                let frame;
                const animate = () => {
                    setAnimated(p => {
                        if (p >= percent) return percent;
                        const diff = percent - p;
                        const step = Math.max(1, Math.ceil(diff / 5));
                        return p + step;
                    });
                    frame = requestAnimationFrame(animate);
                };
                animate();
                return () => cancelAnimationFrame(frame);
            }, [percent]);

            const offset = circumference - (animated / 100) * circumference;

            return (
                <svg width={size} height={size} className="-rotate-90">
                    <circle cx={size/2} cy={size/2} r={radius}
                        stroke="currentColor" strokeWidth={stroke}
                        className="text-gray-300 dark:text-gray-700 opacity-30" fill="none" />
                    <circle cx={size/2} cy={size/2} r={radius}
                        stroke="currentColor" strokeWidth={stroke}
                        strokeDasharray={circumference}
                        strokeDashoffset={offset}
                        strokeLinecap="round"
                        className="text-indigo-500 transition-all duration-300" fill="none" />
                </svg>
            );
        }

        function SeasonProgressRings({ series }) {
            if (!series?.seasons) return null;

            return (
                <div className="flex gap-4 flex-wrap">
                    {series.seasons.map(season => {
                        const total = season.episodes?.length || 0;
                        const watched = season.episodes?.filter(e => e.watched).length || 0;
                        const percent = total ? Math.round((watched / total) * 100) : 0;

                        return (
                            <div key={season.season} className="flex flex-col items-center gap-1">
                                <AnimatedProgressRing percent={percent} size={32} stroke={3} />
                                <span className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">S{season.season}</span>
                            </div>
                        );
                    })}
                </div>
            );
        }

        function AutoAdvanceControls({ series, onUpdate }) {
            const { markNext, undo, lastAction } = useAutoAdvance(series, onUpdate);
            
            const isCompleted = useMemo(() => {
                if(!series?.seasons) return false;
                return series.seasons.every(s => s.episodes.every(e => e.watched));
            }, [series]);

            if (isCompleted) return (
                <div className="flex items-center gap-2 px-3 py-2 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 rounded-lg text-xs font-bold border border-green-200 dark:border-green-800 opacity-80">
                    <CheckCircle size={14} /> Completed
                </div>
            );

            return (
                <div className="flex items-center gap-2">
                    <button
                        onClick={markNext}
                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-bold shadow-lg shadow-indigo-600/30 transition-all flex items-center gap-2"
                    >
                        <Play size={12} fill="currentColor" />
                        Next Episode
                    </button>

                    {lastAction && (
                        <button
                            onClick={undo}
                            className="px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-xs font-bold transition-all"
                        >
                            Undo
                        </button>
                    )}
                </div>
            );
        }

        function SeasonHeatmap({ season }) {
            if(!season.episodes) return null;
            return (
                <div className="flex flex-wrap gap-1 max-w-full">
                    {season.episodes.map(ep => (
                        <div
                            key={ep.episode}
                            title={`Episode ${ep.episode}: ${ep.title || 'Untitled'}`}
                            className={`w-2.5 h-2.5 rounded-sm transition-colors ${
                                ep.watched
                                    ? "bg-indigo-500"
                                    : "bg-gray-200 dark:bg-gray-800"
                            }`}
                        />
                    ))}
                </div>
            );
        }
        
        function EpisodeStreakBadge({ items }) {
            const { streak } = useEpisodeStreak(items);
            if (!streak) return null;
            return (
                <div className="flex items-center gap-2 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 px-3 py-1.5 rounded-full text-xs font-bold border border-orange-200 dark:border-orange-800/50 animate-fade-in">
                    ðŸ”¥ {streak}-day streak
                </div>
            );
        }

        function SeriesTimeline({ series }) {
            if (!series?.seasons) return null;
            return (
                <div className="space-y-6">
                    {series.seasons.map(season => (
                        <SeasonTimeline key={season.season} season={season} />
                    ))}
                </div>
            );
        }

        function SeasonTimeline({ season }) {
            return (
                <div>
                    <h4 className="text-xs font-black uppercase tracking-widest text-gray-500 mb-4 px-2">Season {season.season}</h4>
                    <div className="relative border-l-2 border-gray-100 dark:border-gray-800 ml-4 space-y-6 pb-2">
                        {season.episodes.map(ep => (
                            <TimelineEpisode key={ep.episode} ep={ep} />
                        ))}
                    </div>
                </div>
            );
        }

        function TimelineEpisode({ ep }) {
            return (
                <div className="relative pl-6">
                    <span className={`absolute left-[-5px] top-1.5 w-2.5 h-2.5 rounded-full ring-4 ring-white dark:ring-dark-card transition-colors ${ep.watched ? "bg-indigo-500" : "bg-gray-300 dark:bg-gray-700"}`} />
                    <div className={`text-sm transition-opacity ${ep.watched ? 'opacity-100' : 'opacity-60'}`}>
                        <div className="font-bold dark:text-white flex items-center gap-2">
                            <span className="font-mono text-gray-400 text-xs">E{ep.episode}</span>
                            {ep.title || `Episode ${ep.episode}`}
                        </div>
                        {ep.airDate && (
                            <div className="text-[10px] uppercase font-bold tracking-wider text-gray-400 mt-0.5">{ep.airDate}</div>
                        )}
                    </div>
                </div>
            );
        }

        function SeriesCompletionStat({ items }) {
            const percent = useMemo(() => {
                let watched = 0;
                let total = 0;

                items.forEach(item => {
                    if (item.Type !== "series") return;
                    item.meta?.series?.seasons?.forEach(s => {
                        s.episodes?.forEach(ep => {
                            total++;
                            if (ep.watched) watched++;
                        });
                    });
                });

                return total ? Math.round((watched / total) * 100) : 0;
            }, [items]);

            return (
                <div className="bg-white dark:bg-dark-card rounded-xl p-4 shadow-sm flex items-center gap-4 border border-gray-100 dark:border-gray-800">
                    <AnimatedProgressRing percent={percent} size={48} stroke={5} />
                    <div>
                        <div className="text-sm font-black dark:text-white uppercase tracking-wider">Series Completion</div>
                        <div className="text-xs text-gray-500">{percent}% of all tracked episodes</div>
                    </div>
                </div>
            );
        }

        function SeriesProgressBadge({ series }) {
            const { watched, total, percent } = useSeriesProgress(series);
            if (!total) return null;
            return (
                <div className="relative flex items-center justify-center bg-black/60 rounded-full backdrop-blur-md p-0.5 shadow-lg">
                    <AnimatedProgressRing percent={percent} size={36} stroke={3.5} />
                    <span className="absolute text-[9px] font-black text-white">
                        {percent}%
                    </span>
                </div>
            );
        }

        function SeriesProgressInline({ series }) {
            const { watched, total, percent } = useSeriesProgress(series);
            if (!total) return null;
            return (
                <div className="flex items-center gap-2">
                    <div className="relative flex items-center justify-center">
                         <AnimatedProgressRing percent={percent} size={24} stroke={3} />
                    </div>
                    <div className="text-[10px] leading-tight">
                        <div className="font-bold dark:text-white">{watched}/{total} eps</div>
                        <div className="opacity-60 dark:text-gray-400">{percent}% complete</div>
                    </div>
                </div>
            );
        }

        // --- INSIGHTS / ADVANCED ANALYTICS ---

        function MonthlyWatchChart({ items }) {
            const data = useMemo(() => {
                const months = {};
                items.forEach(item => {
                    const date = item.userMeta?.watchedOn;
                    if (!date) return;
                    const key = date.slice(0, 7); // YYYY-MM
                    months[key] = (months[key] || 0) + 1;
                });
                return Object.entries(months).sort((a, b) => a[0].localeCompare(b[0])).slice(-12);
            }, [items]);
            
            const max = Math.max(...data.map(d => d[1]), 1);

            return (
                <InsightCard title="Monthly Watching Habits" icon={Calendar}>
                    {data.length > 0 ? data.map(([month, count]) => (
                        <InsightBar key={month} label={month} value={count} max={max} />
                    )) : <div className="text-xs text-gray-500 text-center py-4">No data yet</div>}
                </InsightCard>
            );
        }

        function PeopleAnalytics({ items }) {
            const { directors, actors } = useMemo(() => {
                const directors = {};
                const actors = {};
                items.forEach(item => {
                    const meta = item.meta || {};
                    if (meta.director) {
                        const list = Array.isArray(meta.director) ? meta.director : meta.director.split(",");
                        list.forEach(d => { const key = d.trim(); if(key !== "N/A") directors[key] = (directors[key] || 0) + 1; });
                    }
                    meta.cast?.forEach(c => { if (c?.name) actors[c.name] = (actors[c.name] || 0) + 1; });
                });
                return {
                    directors: Object.entries(directors).sort((a, b) => b[1] - a[1]).slice(0, 5),
                    actors: Object.entries(actors).sort((a, b) => b[1] - a[1]).slice(0, 5)
                };
            }, [items]);

            return (
                <InsightCard title="Your People" icon={User}>
                    <InsightSection title="Directors">
                        {directors.map(([name, count]) => <InsightRow key={name} label={name} value={count} />)}
                    </InsightSection>
                    <InsightSection title="Actors">
                        {actors.map(([name, count]) => <InsightRow key={name} label={name} value={count} />)}
                    </InsightSection>
                </InsightCard>
            );
        }

        function TasteProfile({ items }) {
            const profile = useMemo(() => {
                let slowDrama = 0; let action = 0; let foreign = 0;
                items.forEach(item => {
                    if (item.Genre?.includes("Drama")) slowDrama++;
                    if (item.Genre?.includes("Action")) action++;
                    if (item.Language && !item.Language.includes("English")) foreign++;
                });
                const total = items.length || 1;
                return [
                    { label: "Drama-leaning", value: Math.round((slowDrama / total) * 100) },
                    { label: "Action-driven", value: Math.round((action / total) * 100) },
                    { label: "International", value: Math.round((foreign / total) * 100) }
                ];
            }, [items]);

            return (
                <InsightCard title="Your Taste Profile" icon={TrendingUp}>
                    {profile.map(p => <InsightBar key={p.label} label={p.label} value={p.value} max={100} suffix="%" />)}
                </InsightCard>
            );
        }

        function Achievements({ items }) {
            const achievements = useMemo(() => {
                const watched = items.filter(i => i.userMeta?.status === "watched").length;
                const rewatches = items.reduce((a, b) => a + (b.userMeta?.rewatchCount || 0), 0);
                return [
                    { label: "First 10 Watched", unlocked: watched >= 10 },
                    { label: "50 Titles Club", unlocked: watched >= 50 },
                    { label: "Century Viewer", unlocked: watched >= 100 },
                    { label: "Rewatcher", unlocked: rewatches >= 5 }
                ];
            }, [items]);

            return (
                <InsightCard title="Achievements" icon={Award}>
                    <div className="grid grid-cols-2 gap-3">
                        {achievements.map(a => (
                            <div key={a.label} className={`p-3 rounded-lg text-xs font-bold text-center border transition-all ${a.unlocked ? "bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-900/30" : "bg-gray-50 text-gray-400 border-gray-100 dark:bg-gray-800/50 dark:border-gray-800"}`}>
                                {a.label}
                            </div>
                        ))}
                    </div>
                </InsightCard>
            );
        }

        // --- SHARED UI HELPERS FOR INSIGHTS ---
        function InsightCard({ title, icon: Icon, children }) {
            return (
                <div className="bg-white dark:bg-dark-card rounded-xl p-6 shadow-sm border border-gray-100 dark:border-gray-800 space-y-4">
                    <div className="flex items-center gap-2 text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider">
                        <Icon size={16} className="text-indigo-600 dark:text-indigo-400"/> {title}
                    </div>
                    <div className="space-y-3">{children}</div>
                </div>
            );
        }
        function InsightSection({ title, children }) {
            return (
                <div className="space-y-2">
                    <p className="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-2">{title}</p>
                    <div className="space-y-2">{children}</div>
                </div>
            );
        }
        function InsightRow({ label, value }) {
            return (
                <div className="flex justify-between text-xs py-1 border-b border-gray-50 dark:border-gray-800/50 last:border-0">
                    <span className="dark:text-gray-300 truncate pr-2">{label}</span>
                    <span className="font-bold dark:text-white">{value}</span>
                </div>
            );
        }
        function InsightBar({ label, value, max, suffix = "" }) {
            const percentage = Math.min((value / max) * 100, 100);
            return (
                <div>
                    <div className="flex justify-between text-[10px] mb-1 font-bold dark:text-gray-400">
                        <span>{label}</span>
                        <span>{value}{suffix}</span>
                    </div>
                    <div className="h-2 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-500" style={{ width: `${percentage}%` }} />
                    </div>
                </div>
            );
        }

        // ANALYTICS COMPONENTS
        function AnalyticsDashboard({ items }) {
            const stats = useVaultStats(items);
            const [activeTab, setActiveTab] = useState('overview');

            return (
                <div className="space-y-8 animate-fade-in max-w-6xl mx-auto pb-20">
                    {/* Header with Tabs */}
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div className="flex items-center gap-4">
                            <div>
                                <h2 className="text-xl font-bold dark:text-white">Library Analytics</h2>
                                <span className="text-xs text-gray-500">Insights from your vault</span>
                            </div>
                            <EpisodeStreakBadge items={items} />
                        </div>
                        <div className="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1 self-start md:self-auto">
                            <button onClick={() => setActiveTab('overview')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${activeTab === 'overview' ? 'bg-white dark:bg-dark-bg shadow text-indigo-600' : 'text-gray-500 dark:text-gray-400'}`}>Overview</button>
                            <button onClick={() => setActiveTab('insights')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${activeTab === 'insights' ? 'bg-white dark:bg-dark-bg shadow text-indigo-600' : 'text-gray-500 dark:text-gray-400'}`}>Insights</button>
                        </div>
                    </div>

                    {activeTab === 'overview' ? (
                        <div className="space-y-8 animate-fade-in">
                            <EpisodeStreakCalendar items={items} />
                            
                            {/* KPI Cards */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <StatCard icon={BarChart} label="Total Titles" value={stats.total} />
                                <StatCard icon={CheckCircle} label="Watched" value={stats.watched} />
                                <StatCard icon={TrendingUp} label="In Progress" value={stats.progress} />
                                <StatCard icon={Star} label="Avg Rating" value={stats.avgRating} />
                            </div>
                            
                            {/* NEW: Overall Series Completion */}
                            <SeriesCompletionStat items={items} />

                            {/* Charts */}
                            <div className="grid md:grid-cols-2 gap-6">
                                <GenreBreakdown data={stats.byGenre} />
                                <YearTrend data={stats.byYear} />
                            </div>

                            {/* Deep Stats */}
                            <div className="grid md:grid-cols-3 gap-6">
                                <TopRated items={stats.topRated} />
                                <RewatchStats count={stats.rewatchCount} />
                                <LanguageStats data={stats.byLanguage} />
                            </div>
                        </div>
                    ) : (
                        <div className="grid md:grid-cols-2 gap-6 animate-fade-in">
                            <MonthlyWatchChart items={items} />
                            <PeopleAnalytics items={items} />
                            <TasteProfile items={items} />
                            <Achievements items={items} />
                        </div>
                    )}
                </div>
            );
        }

        function StatCard({ icon: Icon, label, value }) {
            return (
                <div className="bg-white dark:bg-dark-card rounded-xl p-4 shadow-sm flex items-center gap-3 border border-gray-100 dark:border-gray-800">
                    <div className="p-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400">
                        <Icon size={18} />
                    </div>
                    <div>
                        <p className="text-[10px] uppercase tracking-wide opacity-60 font-bold dark:text-gray-400">{label}</p>
                        <p className="text-xl font-black dark:text-white">{value}</p>
                    </div>
                </div>
            );
        }

        function GenreBreakdown({ data }) {
            return (
                <Card title="Top Genres">
                    <div className="space-y-3">
                    {Object.entries(data)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 6)
                        .map(([genre, count]) => (
                            <Bar key={genre} label={genre} value={count} max={Math.max(...Object.values(data))} />
                        ))}
                    </div>
                </Card>
            );
        }

        function YearTrend({ data }) {
            const sortedYears = Object.entries(data).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).slice(-6);
            const max = Math.max(...Object.values(data));
            return (
                <Card title="Release Years (Recent)">
                    <div className="space-y-3">
                    {sortedYears.map(([year, count]) => (
                        <Bar key={year} label={year} value={count} max={max} />
                    ))}
                    </div>
                </Card>
            );
        }

        function TopRated({ items }) {
            return (
                <Card title="Top Rated">
                    <ul className="space-y-2">
                        {items.map(item => (
                            <li key={item.imdbID} className="text-sm flex justify-between items-center py-1 border-b border-gray-50 dark:border-gray-800/50 last:border-0">
                                <span className="truncate flex-1 pr-2 dark:text-gray-300">{item.Title}</span>
                                <span className="font-bold text-yellow-500 text-xs flex items-center gap-1"><Star size={10} fill="currentColor"/> {item.userMeta.ratings.overall}</span>
                            </li>
                        ))}
                    </ul>
                </Card>
            );
        }

        function RewatchStats({ count }) {
            return (
                <Card title="Rewatches">
                    <div className="flex flex-col items-center justify-center h-32">
                        <p className="text-5xl font-black text-center text-indigo-600 dark:text-indigo-400">{count}</p>
                        <p className="text-xs text-center opacity-60 mt-2 uppercase tracking-widest font-bold">Total Rewatches</p>
                    </div>
                </Card>
            );
        }

        function LanguageStats({ data }) {
            return (
                <Card title="Languages">
                    <div className="space-y-2">
                    {Object.entries(data)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([lang, count]) => (
                            <div key={lang} className="flex justify-between text-xs py-1 border-b border-gray-50 dark:border-gray-800/50 last:border-0">
                                <span className="dark:text-gray-300">{lang}</span>
                                <span className="font-bold dark:text-white">{count}</span>
                            </div>
                        ))}
                    </div>
                </Card>
            );
        }

        function Card({ title, children }) {
            return (
                <div className="bg-white dark:bg-dark-card rounded-xl p-5 shadow-sm border border-gray-100 dark:border-gray-800">
                    <h3 className="text-xs font-bold uppercase tracking-widest text-gray-500 mb-4">{title}</h3>
                    <div className="space-y-2">{children}</div>
                </div>
            );
        }

        function Bar({ label, value, max }) {
            const percentage = (value / max) * 100;
            return (
                <div>
                    <div className="flex justify-between text-[10px] mb-1 font-bold dark:text-gray-400">
                        <span>{label}</span>
                        <span>{value}</span>
                    </div>
                    <div className="h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                        <div
                            className="h-full bg-indigo-500 rounded-full"
                            style={{ width: `${percentage}%` }}
                        />
                    </div>
                </div>
            );
        }
        
        // Helper Components
        function StatusPill({ icon: Icon, label }) {
            return (
                <div className="flex items-center gap-1.5 bg-black/60 text-white text-[10px] font-bold px-2.5 py-1 rounded-full backdrop-blur-md shadow-sm border border-white/10">
                    <Icon size={10} strokeWidth={3} />
                    {label}
                </div>
            );
        }

        // NEW: Status Component for List View (lighter theme support)
        function Status({ icon: Icon, label }) {
            return (
                <span className="inline-flex items-center gap-1.5 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-2.5 py-1 rounded-full text-[10px] font-bold border border-gray-200 dark:border-gray-700 transition-colors">
                    <Icon size={12} strokeWidth={2.5} />
                    {label}
                </span>
            );
        }

        function Dot() {
            return <span className="w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600" />;
        }

        // 1. SIDEBAR
        function Sidebar({ active, onChange }) {
            const nav = [
                { id: "all", label: "All Items", icon: Layers },
                { id: "watched", label: "Watched", icon: CheckCircle },
                { id: "watchlist", label: "Watchlist", icon: Clock },
                { id: "resume", label: "Resume Watching", icon: FastForward }
            ];

            const smart = [
                { id: "top_rated", label: "Top Rated", icon: Star },
                { id: "rewatch", label: "Rewatch", icon: Repeat },
                { id: "foreign", label: "Foreign", icon: Globe },
                { id: "progress", label: "In Progress", icon: Play }
            ];

            return (
                <aside className="w-64 border-r border-gray-200 dark:border-gray-800 p-4 space-y-8 flex flex-col h-full bg-white dark:bg-dark-bg/50 hidden md:flex">
                    <div className="px-3">
                        <h1 className="text-xl font-black tracking-wide text-gray-900 dark:text-white flex items-center gap-3">
                             <div className="text-indigo-600"><VaultLogoIcon size={48} /></div> THE VAULT
                        </h1>
                    </div>

                    <div className="flex-1 space-y-8">
                        <div>
                             <NavItem active={active === 'analytics'} onClick={() => onChange('analytics')} icon={BarChart}>
                                Analytics
                            </NavItem>
                        </div>
                        
                        <div>
                            <p className="px-3 text-xs uppercase tracking-widest font-bold text-gray-400 mb-3">Library</p>
                            <div className="space-y-1">
                                {nav.map(n => (
                                    <NavItem key={n.id} active={active === n.id} onClick={() => onChange(n.id)} icon={n.icon}>
                                        {n.label}
                                    </NavItem>
                                ))}
                            </div>
                        </div>

                        <div>
                            <p className="px-3 text-xs uppercase tracking-widest font-bold text-gray-400 mb-3">Smart Lists</p>
                            <div className="space-y-1">
                                {smart.map(n => (
                                    <NavItem key={n.id} active={active === n.id} onClick={() => onChange(n.id)} icon={n.icon}>
                                        {n.label}
                                    </NavItem>
                                ))}
                            </div>
                        </div>
                    </div>
                </aside>
            );
        }

        function NavItem({ active, children, onClick, icon: Icon }) {
            return (
                <button
                    onClick={onClick}
                    className={`w-full text-left px-3 py-2.5 rounded-lg text-sm font-medium transition-all flex items-center gap-3 ${
                        active
                            ? "bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400"
                            : "text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800"
                    }`}
                >
                    <Icon size={16} strokeWidth={2} className={active ? "text-indigo-600 dark:text-indigo-400" : "opacity-70"}/>
                    {children}
                </button>
            );
        }

        // 2. TOP COMMAND BAR
        function TopBar({ onToggleFilters, viewMode, setViewMode, searchQuery, setSearchQuery, onSearchFocus, searchResults, onResultClick }) {
            return (
                <header className="sticky top-0 z-40 h-16 bg-white/80 dark:bg-dark-bg/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 flex items-center px-6 gap-6">
                    {/* Mobile Logo */}
                    <div className="md:hidden text-indigo-600 shrink-0">
                        <VaultLogoIcon size={40} />
                    </div>
                    
                    <div className="flex-1 max-w-2xl relative group">
                        <div className="absolute left-3 top-2.5 text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                            <Search size={18} />
                        </div>
                        <input
                            type="text"
                            placeholder="Search movies, series, people..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            onFocus={onSearchFocus}
                            className="w-full bg-gray-100 dark:bg-gray-900 rounded-xl pl-10 pr-4 py-2.5 text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all dark:text-white placeholder:text-gray-400"
                        />
                        {/* Search Dropdown */}
                        {searchResults.length > 0 && (
                            <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-dark-card rounded-xl shadow-2xl border border-gray-100 dark:border-gray-800 max-h-[60vh] overflow-y-auto custom-scrollbar z-50 animate-fade-in">
                                {searchResults.map((item, idx) => (
                                    <div key={idx} onClick={() => onResultClick(item)} className="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer border-b border-gray-100 dark:border-gray-800 last:border-0 transition-colors">
                                        {item.media_type === 'person' ? (
                                             <div className="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 text-xs font-bold">{item.Title.charAt(0)}</div>
                                        ) : (
                                            <img src={getHighResPoster(item.Poster, 100)} className="w-8 h-10 object-cover rounded bg-gray-200" />
                                        )}
                                        <div className="flex-1">
                                            <div className="font-bold text-sm dark:text-white">{item.Title}</div>
                                            <div className="text-xs text-gray-500 capitalize">{item.media_type === 'person' ? 'Person' : `${item.Year} â€¢ ${item.Type}`}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="flex items-center gap-2">
                        <button onClick={() => setViewMode(v => v === "grid" ? "list" : "grid")} className="p-2 text-gray-500 hover:text-indigo-600 dark:text-gray-400 dark:hover:text-indigo-400 transition-colors">
                            {viewMode === "grid" ? <List size={20} /> : <Grid size={20} />}
                        </button>
                        <button onClick={onToggleFilters} className="flex items-center gap-2 px-3 py-2 text-sm font-bold text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <Filter size={16} /> Filters
                        </button>
                    </div>
                </header>
            );
        }

        // 3. MEDIA VIEWS (Grid & List)
        
        // Shared Empty State
        function EmptyState() {
             return (
                <div className="h-full flex flex-col items-center justify-center opacity-60 animate-fade-in pb-32">
                    <Layers size={48} className="mb-4 text-gray-300 dark:text-gray-600" strokeWidth={1} />
                    <p className="text-lg font-bold text-gray-900 dark:text-white">Your vault is empty</p>
                    <p className="text-sm text-gray-500">Search or add your first title</p>
                </div>
            );
        }

        // Grid Container
        function MediaGrid({ items, onItemClick }) {
            return (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-6 pb-20 animate-fade-in">
                    {items.map(item => (
                        <MediaCard key={item.imdbID} item={item} onClick={() => onItemClick(item)} />
                    ))}
                </div>
            );
        }

        // List Container
        function MediaListView({ items, onOpen }) {
            return (
                <div className="flex flex-col gap-3 pb-20 animate-fade-in max-w-5xl mx-auto">
                    {items.map(item => (
                        <MediaListRow
                            key={item.imdbID}
                            item={item}
                            onOpen={onOpen}
                        />
                    ))}
                </div>
            );
        }

        // List Row Item
        function MediaListRow({ item, onOpen }) {
            const status = (item.Type === 'series' && item.userMeta?.series?.lastEpisode?.season > 0 && item.userMeta?.status !== 'watched') 
                ? 'progress' 
                : item.userMeta?.status;
            const rating = item.userMeta?.ratings?.overall;

            return (
                <button
                    onClick={() => onOpen?.(item)}
                    className="group w-full text-left focus:outline-none"
                >
                     <div className="flex items-center gap-4 p-3 bg-white dark:bg-dark-card/50 hover:bg-white dark:hover:bg-dark-card rounded-2xl border border-gray-100 dark:border-gray-800 hover:border-indigo-500/30 dark:hover:border-indigo-500/30 transition-all shadow-sm hover:shadow-md group-focus:ring-2 ring-indigo-500/20">
                        {/* Poster Thumb */}
                         <div className="w-12 h-16 shrink-0 rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-800 relative shadow-inner">
                             <img
                                src={tmdbImg(item.tmdb?.credits?.images?.posters?.[0]?.file_path, "w154") || getHighResPoster(item.Poster, 200)}
                                alt={item.Title}
                                loading="lazy"
                                className="w-full h-full object-cover"
                            />
                        </div>

                        {/* Title + Meta */}
                        <div className="flex-1 min-w-0">
                            <h3 className="text-sm font-bold text-gray-900 dark:text-white truncate group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                                {item.Title}
                            </h3>
                            <div className="flex items-center gap-2 text-xs font-medium text-gray-500 dark:text-gray-400 mt-0.5">
                                <span>{item.Year}</span>
                                <Dot />
                                <span className="uppercase text-[10px] tracking-wider font-bold">{item.Type}</span>
                                {item.Runtime && item.Runtime !== "N/A" && (
                                    <>
                                        <Dot />
                                        <span>{item.Runtime}</span>
                                    </>
                                )}
                            </div>
                            
                            {/* NEW: Inline Progress for List View */}
                            {item.Type === 'series' && item.meta?.series && (
                                <div className="mt-2">
                                    <SeriesProgressInline series={item.meta.series} />
                                </div>
                            )}
                        </div>

                        {/* Status Tags (Desktop) */}
                        <div className="hidden sm:flex items-center gap-2">
                            {status === "watched" && <Status icon={CheckCircle} label="Watched" />}
                            {status === "watchlist" && <Status icon={Clock} label="Watchlist" />}
                            {status === "progress" && <Status icon={Play} label="In Progress" />}
                        </div>

                        {/* Rating */}
                        <div className="flex items-center justify-end w-16 px-2">
                             {rating > 0 ? (
                                <div className="flex items-center gap-1 text-xs font-bold text-gray-900 dark:text-white">
                                    <Star size={14} className="fill-yellow-400 text-yellow-400" />
                                    {rating}
                                </div>
                             ) : (
                                <span className="text-xs font-bold text-gray-300 dark:text-gray-600">â€“</span>
                             )}
                        </div>
                     </div>
                </button>
            );
        }

        // Grid Card Item
        function MediaCard({ item, onClick }) {
            const status = (item.Type === 'series' && item.userMeta?.series?.lastEpisode?.season > 0 && item.userMeta?.status !== 'watched') 
                ? 'progress' 
                : item.userMeta?.status;
            
            const rating = item.userMeta?.ratings?.overall;
            const imgSrc = tmdbImg(item.tmdb?.credits?.images?.posters?.[0]?.file_path, "w500") || getHighResPoster(item.Poster, 500);

            return (
                <button 
                    onClick={onClick} 
                    className="group text-left focus:outline-none w-full"
                >
                    {/* Poster Container */}
                    <div className="relative rounded-2xl overflow-hidden bg-gray-200 dark:bg-gray-800 shadow-sm transition-all duration-300 group-hover:scale-[1.02] group-hover:shadow-xl ring-1 ring-black/5 dark:ring-white/5">
                        <div className="aspect-[2/3] w-full relative">
                             <img 
                                src={imgSrc} 
                                alt={item.Title} 
                                loading="lazy" 
                                className="w-full h-full object-cover" 
                            />
                            
                            {/* NEW: Series Progress Badge Overlay */}
                            {item.Type === 'series' && item.meta?.series && (
                                <div className="absolute top-2 left-2 z-10">
                                    <SeriesProgressBadge series={item.meta.series} />
                                </div>
                            )}
                            
                            {/* Hover Overlay */}
                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex flex-col justify-between p-3">
                                {/* Top-right quick status */}
                                <div className="self-end transform translate-y-[-4px] group-hover:translate-y-0 transition-transform duration-200">
                                    {status === "watched" && <StatusPill icon={CheckCircle} label="Watched" />}
                                    {status === "watchlist" && <StatusPill icon={Clock} label="Watchlist" />}
                                    {status === "progress" && <StatusPill icon={Play} label="In Progress" />}
                                </div>
                                
                                {/* Bottom metadata */}
                                <div className="flex items-center justify-between w-full transform translate-y-2 group-hover:translate-y-0 transition-transform duration-200">
                                    <div className="flex items-center gap-1.5 text-white text-xs font-bold shadow-black/50 drop-shadow-md">
                                         <Star size={14} className="fill-yellow-400 text-yellow-400" />
                                         {rating || "â€“"}
                                    </div>
                                    <span className="text-[9px] text-white/90 uppercase tracking-wider font-bold bg-white/10 px-1.5 py-0.5 rounded backdrop-blur-md border border-white/10">
                                        {item.Type === 'series' ? 'TV' : item.Type}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Title Block */}
                    <div className="mt-3 px-1 space-y-0.5">
                        <h3 className="text-sm font-bold text-gray-900 dark:text-white truncate group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                            {item.Title}
                        </h3>
                        <div className="flex items-center gap-2 text-xs font-medium text-gray-500 dark:text-gray-400">
                             <span>{item.Year}</span>
                             {item.Runtime && item.Runtime !== "N/A" && (
                                 <>
                                    <Dot />
                                    <span>{item.Runtime}</span>
                                 </>
                             )}
                        </div>
                    </div>
                </button>
            );
        }

        // 4. FILTER DRAWER
        const FilterSelect = ({ label, options, value, onChange }) => (
            <div className="flex flex-col gap-2">
                <label className="text-xs uppercase font-bold text-gray-500 tracking-wider">{label}</label>
                <select multiple value={value} onChange={(e) => onChange([...e.target.selectedOptions].map(o => o.value))} className="w-full h-24 bg-gray-100 dark:bg-gray-800 rounded-lg text-xs p-2 outline-none focus:ring-2 focus:ring-indigo-500/50 dark:text-gray-300 custom-scrollbar">
                    {options.map(o => <option key={o} value={o} className="py-1 px-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700">{o}</option>)}
                </select>
            </div>
        );

        function FilterDrawer({ isOpen, onClose, filters, setFilters, filterOptions, sortBy, setSortBy }) {
             return (
                <>
                    {isOpen && <div className="fixed inset-0 bg-black/30 z-[90] drawer-backdrop transition-opacity" onClick={onClose} />}
                    <div className={`fixed right-0 top-0 h-full w-80 bg-white dark:bg-dark-card shadow-2xl z-[95] transform transition-transform duration-300 ease-out flex flex-col p-6 space-y-6 ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                         <div className="flex justify-between items-center">
                             <h2 className="text-lg font-black dark:text-white">Filters & Sort</h2>
                             <button onClick={onClose}><X size={20} className="text-gray-400 hover:text-gray-900 dark:hover:text-white"/></button>
                         </div>
                         
                         <div className="flex-1 overflow-y-auto space-y-6 custom-scrollbar -mr-4 pr-4">
                            <div>
                                <p className="text-xs uppercase opacity-50 mb-2 font-bold">Sort Order</p>
                                <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="w-full bg-gray-100 dark:bg-gray-800 rounded-lg p-2.5 text-sm font-medium dark:text-white outline-none">
                                    <option value="updated">Last Updated</option>
                                    <option value="name">Title (A-Z)</option>
                                    <option value="year">Release Year</option>
                                    <option value="rating">Rating</option>
                                </select>
                            </div>

                            <div className="space-y-4">
                                <FilterSelect label="Genre" options={filterOptions.genres} value={filters.genre} onChange={(v) => setFilters(f => ({ ...f, genre: v }))} />
                                <FilterSelect label="Director" options={filterOptions.directors} value={filters.director} onChange={(v) => setFilters(f => ({ ...f, director: v }))} />
                            </div>
                         </div>
                         
                         <button onClick={() => setFilters({ genre: [], director: [], actor: [], studio: [] })} className="w-full border border-gray-200 dark:border-gray-700 text-gray-500 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 dark:hover:bg-gray-800">Reset Filters</button>
                         <button onClick={onClose} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-indigo-600/20">Show Results</button>
                    </div>
                </>
            );
        }

        // --- AUTH, SETTINGS, & DETAIL MODALS (Preserving Logic) ---
        const AuthModal = ({ isOpen, onClose, onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            if (!isOpen) return null;
            const handleSubmit = async (e) => { e.preventDefault(); setError(""); try { if (isRegister) { const { error } = await supabaseClient.auth.signUp({ email, password }); if (error) throw error; alert("Registered! Login now."); setIsRegister(false); } else { const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) throw error; onLogin(data.session); onClose(); } } catch (err) { setError(err.message); } };
            return ( <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"> <div className="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl shadow-2xl p-8 relative"> <h2 className="text-xl font-black text-center mb-6 dark:text-white">{isRegister ? 'Join Vault' : 'Welcome Back'}</h2> {error && <div className="text-red-500 text-xs mb-4">{error}</div>} <form onSubmit={handleSubmit} className="space-y-4"> <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-3 text-sm outline-none dark:text-white" required /> <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-3 text-sm outline-none dark:text-white" required /> <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl">{isRegister ? 'Create Account' : 'Login'}</button> </form> <button onClick={() => setIsRegister(!isRegister)} className="w-full mt-4 text-xs text-gray-500"> {isRegister ? 'Already have an account?' : 'Need an account?'} </button> <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={18}/></button> </div> </div> );
        };

        // --- APP SHELL ---
        function App() {
            // State
            const [session, setSession] = useState(null);
            const [vault, setVault] = useState({ watched: {}, watchlist: {} });
            const [navFilter, setNavFilter] = useState("all"); // all, watched, watchlist, top_rated...
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [viewMode, setViewMode] = useState("grid");
            const [showFilters, setShowFilters] = useState(false);
            const [filters, setFilters] = useState({ genre: [], director: [], actor: [], studio: [] });
            const [sortBy, setSortBy] = useState('updated');
            const [apiKeys, setApiKeys] = useState(DEFAULT_KEYS);
            const [showAuth, setShowAuth] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [detailTab, setDetailTab] = useState('overview'); // overview, timeline
            
            // Refs & Data
            const searchTimeout = useRef(null);
            const isAdmin = session && ADMIN_IDS.includes(session.user.id);
            const allItems = useMemo(() => [...Object.values(vault.watched), ...Object.values(vault.watchlist)], [vault]);

            // Logic: Filter Data
            const processedItems = useMemo(() => {
                let items = allItems;
                
                // 1. Sidebar Filter
                if (navFilter === 'watched') items = items.filter(i => i.userMeta.status === 'watched');
                else if (navFilter === 'watchlist') items = items.filter(i => i.userMeta.status === 'watchlist');
                else if (navFilter === 'top_rated') items = items.filter(i => i.userMeta?.ratings?.overall >= 9);
                else if (navFilter === 'rewatch') items = items.filter(i => i.userMeta?.rewatchCount > 0);
                else if (navFilter === 'foreign') items = items.filter(i => i.Language && !i.Language.includes('English'));
                else if (navFilter === 'progress') items = items.filter(i => i.userMeta?.series?.lastEpisode?.season > 0);
                // NEW: Resume Watching Filter
                else if (navFilter === 'resume') {
                    items = items.filter(item => {
                        if (item.Type !== "series") return false;
                        const series = item.meta?.series;
                        if (!series?.seasons) return false;
                        let watched = 0, total = 0;
                        series.seasons.forEach(s => s.episodes.forEach(ep => {
                            total++;
                            if (ep.watched) watched++;
                        }));
                        return watched > 0 && watched < total;
                    });
                }
                else if (navFilter === 'analytics') return []; // Handled separately in render

                // 2. Search
                if (searchQuery && searchQuery.length < 3) items = items.filter(i => i.Title.toLowerCase().includes(searchQuery.toLowerCase()));
                
                // 3. Drawer Filters
                items = items.filter(item => {
                    const itemGenres = Array.isArray(item.meta?.genre) ? item.meta.genre : item.Genre?.split(",").map(g => g.trim()) || [];
                    const itemDirectors = Array.isArray(item.meta?.director) ? item.meta.director : (item.meta?.director ? [item.meta.director] : []);
                    const includes = (source, target) => target.length === 0 || target.some(t => source.includes(t));
                    return includes(itemGenres, filters.genre) && includes(itemDirectors, filters.director);
                });

                // 4. Sort
                items.sort((a, b) => {
                    if (sortBy === "name") return a.Title.localeCompare(b.Title);
                    if (sortBy === "year") return (parseInt(b.Year)||0) - (parseInt(a.Year)||0); // desc default
                    if (sortBy === "rating") return (b.userMeta?.ratings?.overall || 0) - (a.userMeta?.ratings?.overall || 0);
                    return (b.userMeta?.lastUpdated || 0) - (a.userMeta?.lastUpdated || 0);
                });

                return items;
            }, [allItems, navFilter, searchQuery, filters, sortBy]);

            const filterOptions = useMemo(() => {
                const genres = new Set(); const directors = new Set();
                allItems.forEach(i => {
                     (Array.isArray(i.meta?.genre) ? i.meta.genre : i.Genre?.split(",") || []).forEach(g => genres.add(g.trim()));
                     (Array.isArray(i.meta?.director) ? i.meta.director : [i.meta?.director]).filter(Boolean).forEach(d => directors.add(d));
                });
                return { genres: [...genres].sort(), directors: [...directors].sort() };
            }, [allItems]);

            // Effects
            useEffect(() => { const k = localStorage.getItem('vault_v5_keys'); if(k) setApiKeys(JSON.parse(k)); const v = localStorage.getItem('vault_v6_data'); if(v) setVault(JSON.parse(v)); }, []);
            useEffect(() => { supabaseClient.auth.getSession().then(({ data }) => setSession(data.session)); const { data: l } = supabaseClient.auth.onAuthStateChange((_, s) => setSession(s)); return () => l.subscription.unsubscribe(); }, []);
            
            // Search Logic
            const handleSearch = async (val) => {
                setSearchQuery(val);
                if (searchTimeout.current) clearTimeout(searchTimeout.current);
                if (val.length < 3) { setSearchResults([]); return; }
                searchTimeout.current = setTimeout(async () => {
                    try {
                        const res = await fetch(`https://www.omdbapi.com/?apikey=${apiKeys.omdb}&s=${encodeURIComponent(val)}`);
                        const json = await res.json();
                        setSearchResults(json.Search || []);
                    } catch(e) {}
                }, 400);
            };

            // Actions
            const addToVault = async (imdbID) => {
                if (!isAdmin) return; // Simple protection
                const res = await fetch(`https://www.omdbapi.com/?apikey=${apiKeys.omdb}&i=${imdbID}&plot=full`);
                const json = await res.json();
                if (json.Response === "True") {
                    const item = { ...json, userMeta: { status: 'watchlist', ratings: { overall: 0 }, lastUpdated: Date.now() }, meta: { genre: json.Genre.split(', '), director: json.Director }, tmdb: { enriched: false } }; // Simplified migrate for brevity
                    setVault(prev => {
                        const next = { ...prev, watchlist: { ...prev.watchlist, [imdbID]: item } };
                        localStorage.setItem("vault_v6_data", JSON.stringify(next));
                        return next;
                    });
                    setSearchResults([]); setSearchQuery("");
                }
            };
            
            const handleUpdateStatus = (id, status) => {
                 setVault(prev => {
                    const item = prev.watched[id] || prev.watchlist[id];
                    if (!item) return prev;
                    item.userMeta.status = status;
                    const next = { watched: { ...prev.watched }, watchlist: { ...prev.watchlist } };
                    delete next.watched[id]; delete next.watchlist[id];
                    if (status === 'watched') next.watched[id] = item; else next.watchlist[id] = item;
                    localStorage.setItem("vault_v6_data", JSON.stringify(next));
                    return next;
                 });
                 if (selectedItem?.imdbID === id) setSelectedItem(null);
            };
            
            // NEW: Handle marking individual episodes (with Undo)
            const handleMarkEpisode = ({ season, episode, undo }) => {
                const imdbID = selectedItem.imdbID;
                setVault(prev => {
                    const item = prev.watched[imdbID] || prev.watchlist[imdbID];
                    if (!item || !item.meta?.series?.seasons) return prev;

                    // Deep copy to avoid mutation issues
                    const newItem = JSON.parse(JSON.stringify(item));
                    const s = newItem.meta.series.seasons.find(s => s.season === season);
                    if (s) {
                        const ep = s.episodes.find(e => e.episode === episode);
                        if (ep) {
                            ep.watched = !undo; // True if marking, false if undoing
                            
                            // Update last episode logic
                            if (!undo) {
                                if (!newItem.userMeta.series) newItem.userMeta.series = {};
                                newItem.userMeta.series.lastEpisode = { season: season, episode: episode };
                                newItem.userMeta.lastUpdated = Date.now();
                                newItem.userMeta.watchedOn = new Date().toISOString().split('T')[0]; // For streaks
                            }
                        }
                    }
                    
                    // Save back
                    const next = { watched: {...prev.watched}, watchlist: {...prev.watchlist} };
                    if (newItem.userMeta.status === 'watched') next.watched[imdbID] = newItem;
                    else next.watchlist[imdbID] = newItem;
                    
                    // Update currently selected item if open
                    if (selectedItem?.imdbID === imdbID) {
                        setSelectedItem(newItem);
                    }
                    
                    localStorage.setItem("vault_v6_data", JSON.stringify(next));
                    return next;
                });
            };

            return (
                <div className="h-screen flex bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text">
                    <Sidebar active={navFilter} onChange={setNavFilter} />

                    <div className="flex-1 flex flex-col min-w-0">
                        <TopBar 
                            onToggleFilters={() => setShowFilters(true)}
                            viewMode={viewMode}
                            setViewMode={setViewMode}
                            searchQuery={searchQuery}
                            setSearchQuery={handleSearch}
                            searchResults={searchResults}
                            onSearchFocus={() => {}}
                            onResultClick={(item) => addToVault(item.imdbID)}
                        />

                        <main className="flex-1 overflow-y-auto p-6 scroll-smooth">
                            <GentleReminder items={allItems} />
                            
                            {navFilter === 'analytics' ? (
                                <AnalyticsDashboard items={allItems} />
                            ) : processedItems.length === 0 ? (
                                <EmptyState />
                            ) : viewMode === 'grid' ? (
                                <MediaGrid items={processedItems} onItemClick={setSelectedItem} />
                            ) : (
                                <MediaListView items={processedItems} onOpen={setSelectedItem} />
                            )}
                        </main>
                    </div>

                    <FilterDrawer 
                        isOpen={showFilters} 
                        onClose={() => setShowFilters(false)}
                        filters={filters} setFilters={setFilters}
                        filterOptions={filterOptions}
                        sortBy={sortBy} setSortBy={setSortBy}
                    />
                    
                    {/* Modals */}
                    <AuthModal isOpen={showAuth} onClose={() => setShowAuth(false)} onLogin={setSession} />
                    
                    {/* Detail Modal */}
                    {selectedItem && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white dark:bg-dark-card w-full max-w-lg rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto custom-scrollbar flex flex-col">
                                <button onClick={() => setSelectedItem(null)} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X size={20}/></button>
                                <div className="flex gap-4 mb-6">
                                    <img src={getHighResPoster(selectedItem.Poster, 200)} className="w-24 h-36 object-cover rounded-lg shadow-md" />
                                    <div className="flex-1">
                                        <h2 className="text-xl font-black dark:text-white leading-tight">{selectedItem.Title}</h2>
                                        <div className="flex items-center gap-3 my-2 text-sm text-gray-500">
                                            <span>{selectedItem.Year}</span>
                                            {selectedItem.Type === 'series' && selectedItem.meta?.series && (
                                                <SeriesProgressInline series={selectedItem.meta.series} />
                                            )}
                                        </div>
                                        <p className="text-sm text-gray-600 dark:text-gray-300 line-clamp-4">{selectedItem.Plot}</p>
                                    </div>
                                </div>
                                
                                {/* NEW: Series Progress Section with Tabs */}
                                {selectedItem.Type === 'series' && selectedItem.meta?.series && (
                                    <div className="mb-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-800 flex-1 overflow-y-auto">
                                        <div className="flex justify-between items-center mb-4">
                                            <div className="flex gap-1 bg-white dark:bg-dark-card rounded-lg p-1 border border-gray-200 dark:border-gray-700">
                                                <button onClick={() => setDetailTab('overview')} className={`px-3 py-1 rounded-md text-[10px] uppercase font-bold transition-all ${detailTab === 'overview' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400' : 'text-gray-500'}`}>Overview</button>
                                                <button onClick={() => setDetailTab('timeline')} className={`px-3 py-1 rounded-md text-[10px] uppercase font-bold transition-all ${detailTab === 'timeline' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400' : 'text-gray-500'}`}>Timeline</button>
                                            </div>
                                            <AutoAdvanceControls series={selectedItem.meta.series} onUpdate={handleMarkEpisode} />
                                        </div>
                                        
                                        {detailTab === 'overview' ? (
                                            <div className="animate-fade-in">
                                                <div className="mb-4 overflow-x-auto pb-2">
                                                    <SeasonProgressRings series={selectedItem.meta.series} />
                                                </div>
                                                
                                                <div className="space-y-4">
                                                    {selectedItem.meta.series.seasons.map(s => (
                                                        <div key={s.season}>
                                                            <div className="flex justify-between items-end mb-1">
                                                                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Season {s.season}</span>
                                                                <span className="text-[10px] text-gray-500">{s.episodes.filter(e=>e.watched).length}/{s.episodes.length}</span>
                                                            </div>
                                                            <SeasonHeatmap season={s} />
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="animate-fade-in max-h-60 overflow-y-auto custom-scrollbar">
                                                <SeriesTimeline series={selectedItem.meta.series} />
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="flex gap-3 mt-auto">
                                    <button onClick={() => handleUpdateStatus(selectedItem.imdbID, 'watched')} className="flex-1 py-3 bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 rounded-xl font-bold text-sm hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">Watched</button>
                                    <button onClick={() => handleUpdateStatus(selectedItem.imdbID, 'watchlist')} className="flex-1 py-3 bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400 rounded-xl font-bold text-sm hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors">Watchlist</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* FAB for Settings/Auth on Mobile or Desktop */}
                    <div className="fixed bottom-6 right-6 flex flex-col gap-3">
                        <button onClick={() => setShowSettings(!showSettings)} className="bg-white dark:bg-dark-card text-gray-500 p-3 rounded-full shadow-lg border border-gray-200 dark:border-gray-800 hover:text-indigo-600 transition-colors">
                            <Settings size={20} />
                        </button>
                        {!session && (
                            <button onClick={() => setShowAuth(true)} className="bg-indigo-600 text-white p-3 rounded-full shadow-lg shadow-indigo-600/30 hover:scale-110 transition-transform">
                                <User size={20} />
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>